# 快速使用指南

## 已下载模型的情况

如果你已经使用 ModelScope 下载了模型，按照以下步骤快速配置和启动系统。

## 第一步：配置模型路径

编辑 `config.py` 文件，设置你的模型路径：

```python
# 配置文件

# Qwen3-Embedding-4B 嵌入模型路径
EMBEDDING_MODEL_PATH = "/mnt/workspace/.cache/modelscope/models/Qwen/Qwen3-Embedding-4B"

# Qwen2.5-3B-Instruct 对话模型路径（注意文件名中的点被转换为三个下划线）
LLM_MODEL_PATH = "/mnt/workspace/.cache/modelscope/models/Qwen/Qwen2___5-3B-Instruct"

# 向量数据库路径
VECTOR_DB_PATH = "./faiss/knowledge"

# 知识库文件路径
KNOWLEDGE_FILE = "knowledge.txt"
```

**重要提示：** 
- ModelScope 下载的模型路径通常在 `~/.cache/modelscope/models/` 或 `/mnt/workspace/.cache/modelscope/models/`
- 模型名称中的点 `.` 会被转换为三个下划线 `___`（例如：`Qwen2.5` → `Qwen2___5`）

## 第二步：安装依赖

```bash
pip install -r requirements.txt
```

**关键依赖：**
- `langchain>=0.2.0` - 新版本避免了弃用警告
- `langchain-community>=0.2.0` - 社区组件包
- 其他依赖见 `requirements.txt`

## 第三步：准备知识库

确保 `knowledge.txt` 文件存在并包含你的业务知识。默认提供了一个服装尺码的示例知识库。

你可以根据需要修改或替换该文件。

## 第四步：创建向量数据库

```bash
python get_vector.py
```

**输出示例：**
```
开始处理知识库文件: knowledge.txt
正在加载文档...
已加载文档数量: 1
正在切分文本...
切分后的文档块数量: 15
正在加载嵌入模型...
正在从本地加载嵌入模型: /mnt/workspace/.cache/modelscope/models/Qwen/Qwen3-Embedding-4B
使用设备: cuda
嵌入模型加载完成！
正在创建向量数据库...
向量数据库已保存到: ./faiss/knowledge
处理完成，共生成 15 个文档块
```

**说明：**
- 这个过程会从本地加载已下载的嵌入模型（不会重新下载）
- 加载文档并切分成小块
- 生成向量并保存到 FAISS 数据库
- 第一次运行模型可能需要几分钟进行初始化

## 第五步：启动问答系统

```bash
python main.py
```

**输出示例：**
```
==================================================
正在初始化QA系统...
==================================================

1. 加载嵌入模型...
正在从本地加载嵌入模型: /mnt/workspace/.cache/modelscope/models/Qwen/Qwen3-Embedding-4B
使用设备: cuda
嵌入模型加载完成！

2. 加载向量数据库...
向量数据库加载完成！

3. 加载对话模型...
正在从本地加载模型: /mnt/workspace/.cache/modelscope/models/Qwen/Qwen2___5-3B-Instruct
使用设备: cuda
模型加载完成！

==================================================
QA系统初始化完成！
==================================================

进入交互式问答模式
输入 'quit' 或 'exit' 退出
输入 'clear' 清空对话历史
--------------------------------------------------

请输入您的问题: 
```

## 第六步：开始问答

系统启动后，你可以直接输入问题：

```
请输入您的问题: 我身高170cm，体重65kg，应该买什么尺码？

正在思考...

回答: 根据尺码对照表，您身高170cm，体重65kg，建议选择L码。
L码适合身高165-170cm，体重57.5-65kg的人群。

请输入您的问题: 
```

## 常见问题解决

### 1. 弃用警告（DeprecationWarning）

如果看到类似这样的警告：
```
LangChainDeprecationWarning: The class `UnstructuredFileLoader` was deprecated...
```

**解决方案：** 已在代码中修复，确保使用：
- `from langchain_community.document_loaders import UnstructuredFileLoader`
- `from langchain_community.vectorstores import FAISS`

### 2. 加载文档时卡住

如果在加载文档时程序卡住很久，可能原因：

**原因 1：文档解析慢**
- `UnstructuredFileLoader` 在解析复杂文档时可能较慢
- 对于纯文本文件，通常几秒内完成
- 对于 PDF/Word 文件，可能需要更长时间

**解决方案：**
- 使用纯文本 `.txt` 文件作为知识库（推荐）
- 或者使用更快的加载器，如 `TextLoader`

### 3. 模型路径错误

如果提示 "模型路径不存在"：

```bash
# 查找你的模型实际路径
find ~/.cache/modelscope -name "Qwen*" -type d
# 或
find /mnt/workspace/.cache/modelscope -name "Qwen*" -type d
```

然后更新 `config.py` 中的路径。

### 4. FAISS 反序列化警告

如果看到关于 `allow_dangerous_deserialization` 的警告，这是正常的。代码中已添加该参数。

### 5. 内存不足

如果出现内存错误：

**方案 1：** 减小文档块大小
```python
# 在 config.py 中
CHUNK_SIZE = 300  # 从 500 减小到 300
```

**方案 2：** 减少检索数量
```python
# 在 config.py 中
TOP_K = 2  # 从 3 减小到 2
```

**方案 3：** 使用 CPU 而非 GPU（如果 GPU 显存不足）

### 6. 更新知识库

如果需要更新知识库内容：

```bash
# 1. 修改 knowledge.txt
vim knowledge.txt

# 2. 删除旧的向量数据库
rm -rf faiss/knowledge/

# 3. 重新创建向量数据库
python get_vector.py

# 4. 重启问答系统
python main.py
```

## 性能优化建议

### GPU 加速

系统会自动检测并使用 GPU。查看是否使用 GPU：

```python
import torch
print(f"CUDA available: {torch.cuda.is_available()}")
print(f"CUDA device: {torch.cuda.get_device_name(0) if torch.cuda.is_available() else 'None'}")
```

### 调整模型参数

编辑 `config.py` 以优化性能：

```python
# 生成参数
MAX_TOKEN = 4096      # 最大生成长度（越大越慢）
TEMPERATURE = 0.8     # 温度（0-1，越高越随机）
TOP_P = 0.9          # 核采样（0-1，越小越确定）

# 检索参数
TOP_K = 3            # 检索文档数（越多越慢，但可能更准确）

# 文档切分参数
CHUNK_SIZE = 500     # 文档块大小（越小切分越细）
CHUNK_OVERLAP = 50   # 重叠部分（用于保持上下文连贯性）
```

## 命令速查

```bash
# 安装依赖
pip install -r requirements.txt

# 下载模型（如果还没有）
python download_models.py

# 创建向量数据库
python get_vector.py

# 启动问答系统
python main.py

# 查看模型路径
find ~/.cache/modelscope -name "Qwen*" -type d

# 删除向量数据库（重建前）
rm -rf faiss/knowledge/
```

## 下一步

- 🎯 根据你的业务需求定制 `knowledge.txt`
- 🔧 调整 `config.py` 中的参数以优化性能
- 🌐 集成 Web 界面（可使用 Gradio 或 Streamlit）
- 📊 添加日志和监控

祝使用愉快！ 🎉
